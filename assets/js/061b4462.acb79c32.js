"use strict";(self.webpackChunkkahunakv_docs=self.webpackChunkkahunakv_docs||[]).push([[7820],{3215:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>u,contentTitle:()=>c,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"distributed-keyvalue-store/cas","title":"Compare-And-Swap (CAS)","description":"A Compare-And-Swap (CAS) operation is critical in a distributed key-value store like Kahuna because it ensures atomic updates and prevents race conditions in environments where multiple clients may try to modify the same key simultaneously. CAS is an atomic operation that:","source":"@site/docs/distributed-keyvalue-store/cas.mdx","sourceDirName":"distributed-keyvalue-store","slug":"/distributed-keyvalue-store/cas","permalink":"/docs/distributed-keyvalue-store/cas","draft":false,"unlisted":false,"editUrl":"https://github.com/kahunakv/kahunakv.github.io/tree/main/docs/docs/distributed-keyvalue-store/cas.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Distributed Key/Value Store","permalink":"/docs/distributed-keyvalue-store"},"next":{"title":"Revisions","permalink":"/docs/distributed-keyvalue-store/revisions"}}');var a=t(4848),r=t(8453),i=t(5537),l=t(9329);const o={},c="Compare-And-Swap (CAS)",u={},d=[{value:"Examples",id:"examples",level:2},{value:"Distributed Queue Consumer Lock",id:"distributed-queue-consumer-lock",level:3},{value:"Feature Flag Update Control",id:"feature-flag-update-control",level:3}];function h(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"compare-and-swap-cas",children:"Compare-And-Swap (CAS)"})}),"\n","\n",(0,a.jsx)(n.p,{children:"A Compare-And-Swap (CAS) operation is critical in a distributed key-value store like Kahuna because it ensures atomic updates and prevents race conditions in environments where multiple clients may try to modify the same key simultaneously. CAS is an atomic operation that:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Compares a key\u2019s current value (or version) against an expected value or revision"}),"\n",(0,a.jsx)(n.li,{children:"Only updates the key if the current value matches the expected value or revision"}),"\n",(0,a.jsx)(n.li,{children:"Fails safely if another process modified the key in the meantime."}),"\n"]}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:(0,a.jsx)(n.strong,{children:"Use Case"})}),(0,a.jsx)(n.th,{children:(0,a.jsx)(n.strong,{children:"How CAS Helps"})})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.strong,{children:"Leader Election"})}),(0,a.jsx)(n.td,{children:"Ensures only one node becomes leader."})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.strong,{children:"Distributed Locks"})}),(0,a.jsx)(n.td,{children:"Prevents multiple nodes from acquiring the same lock."})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.strong,{children:"Configuration Updates"})}),(0,a.jsx)(n.td,{children:"Prevents conflicting writes to shared config values."})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.strong,{children:"Rate Limiting"})}),(0,a.jsx)(n.td,{children:"Ensures atomic updates to request counters."})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.strong,{children:"Concurrent Transactions"})}),(0,a.jsx)(n.td,{children:"Avoids lost updates when multiple clients modify the same key."})]})]})]}),"\n",(0,a.jsx)(n.p,{children:"Advantages of using CAS:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Ensures atomic updates"})," in distributed stores."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Prevents race conditions"})," when multiple clients write to the same key."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Guarantees strong consistency"})," by checking versioning before updating."]}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.strong,{children:"It can be used in leader election, distributed locks, and state coordination."})}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Prevents lost updates"})," and ensures correct data modifications."]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"examples",children:"Examples"}),"\n",(0,a.jsx)(n.p,{children:"The client provides specialized methods to execute CAS operations based on the value or revision:"}),"\n",(0,a.jsx)(n.h3,{id:"distributed-queue-consumer-lock",children:"Distributed Queue Consumer Lock"}),"\n",(0,a.jsx)(n.p,{children:"Use Case: Multiple workers process tasks from a queue but each task should only be handled once"}),"\n",(0,a.jsxs)(i.A,{children:[(0,a.jsxs)(l.A,{value:"CLI",children:[(0,a.jsx)(n.p,{children:"Sets the initial value as usual if it hasn't been assigned previously:"}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-visual-basic",children:'kahuna-cli>  set `locks/tasks/123` "node1" ex 10000 nx\nr0 set 15ms\n'})}),(0,a.jsx)(n.p,{children:"Mark the task as completed if this node still hold the key:"}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-visual-basic",children:'kahuna-cli>  set `locks/tasks/123` "completed" cmp "node1"\nr1 set 11ms\n'})})]}),(0,a.jsx)(l.A,{value:"C#",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:'using Kahuna.Client;\n\npublic async Task HandleTask(KahunaClient client, string taskId)\n{\n    string keyName = "locks/task/" + taskId;\n    string machineName = Environment.MachineName;\n\n    // Sets the initial value as usual if it hasn\'t been assigned previously\n    (bool success, long revision) = await client.SetKeyValue(\n        keyName,\n        machineName,\n        10000,\n        KeyValueFlags.SetIfNotExists\n    );\n\n    if (!success)\n    {\n        Console.WriteLine("Other node acquired the task");\n        return;\n    }\n\n    // Process the task here\n    // ...\n\n    // Mark the task as completed if this node still hold the key\n    (success, revision) = await client.TryCompareValueAndSetKeyValue(keyName, "completed", machineName, 0);\n\n    if (success)\n    {\n        Console.WriteLine("Marked as completed successfully");\n        return;\n    }\n}\n'})})})]}),"\n",(0,a.jsx)(n.h3,{id:"feature-flag-update-control",children:"Feature Flag Update Control"}),"\n",(0,a.jsx)(n.p,{children:"Use Case: Update a feature flag, but only if it hasn\u2019t changed since you last read it."}),"\n",(0,a.jsxs)(i.A,{children:[(0,a.jsxs)(l.A,{value:"CLI",children:[(0,a.jsx)(n.p,{children:"Obtains the current value of the feature flag:"}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-visual-basic",children:"get `feature/new-landing`\nr0 disabled 12ms\n"})}),(0,a.jsx)(n.p,{children:"Change the flag if the revision is still 0:"}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-visual-basic",children:"kahuna-cli>  set `feature/new-landing` 'enabled' cmprev 0\nr1 set 19ms\n"})}),(0,a.jsx)(n.p,{children:"The flag won't change if the revision is not 0:"}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-visual-basic",children:"kahuna-cli>  set `feature/new-landing` 'disabled' cmprev 0\nr1 not set 14ms\n"})})]}),(0,a.jsx)(l.A,{value:"C#",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:'using Kahuna.Client;\n\npublic async Task CheckFeatureFlag(KahunaClient client, string featureName)\n{\n    string featureKey = "feature/" + featureName;\n\n    // Obtains the current value of the feature flag\n    (byte[]? _, long revision) = await client.GetKeyValue(featureKey);\n\n    // ...\n\n    // Check if the flag was changed\n    (success, revision) = await client.TryCompareRevisionAndSetKeyValue(featureKey, "enabled", revision);\n\n    if (success)\n    {\n        Console.WriteLine("No one else changed the flag between our read and write.");\n        return;\n    }\n}\n'})})})]})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},5537:(e,n,t)=>{t.d(n,{A:()=>y});var s=t(6540),a=t(4164),r=t(5627),i=t(6347),l=t(372),o=t(604),c=t(1861),u=t(8749);function d(e){return s.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,s.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function h(e){const{values:n,children:t}=e;return(0,s.useMemo)((()=>{const e=n??function(e){return d(e).map((e=>{let{props:{value:n,label:t,attributes:s,default:a}}=e;return{value:n,label:t,attributes:s,default:a}}))}(t);return function(e){const n=(0,c.XI)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,t])}function p(e){let{value:n,tabValues:t}=e;return t.some((e=>e.value===n))}function m(e){let{queryString:n=!1,groupId:t}=e;const a=(0,i.W6)(),r=function(e){let{queryString:n=!1,groupId:t}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:n,groupId:t});return[(0,o.aZ)(r),(0,s.useCallback)((e=>{if(!r)return;const n=new URLSearchParams(a.location.search);n.set(r,e),a.replace({...a.location,search:n.toString()})}),[r,a])]}function f(e){const{defaultValue:n,queryString:t=!1,groupId:a}=e,r=h(e),[i,o]=(0,s.useState)((()=>function(e){let{defaultValue:n,tabValues:t}=e;if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!p({value:n,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${t.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const s=t.find((e=>e.default))??t[0];if(!s)throw new Error("Unexpected error: 0 tabValues");return s.value}({defaultValue:n,tabValues:r}))),[c,d]=m({queryString:t,groupId:a}),[f,b]=function(e){let{groupId:n}=e;const t=function(e){return e?`docusaurus.tab.${e}`:null}(n),[a,r]=(0,u.Dv)(t);return[a,(0,s.useCallback)((e=>{t&&r.set(e)}),[t,r])]}({groupId:a}),v=(()=>{const e=c??f;return p({value:e,tabValues:r})?e:null})();(0,l.A)((()=>{v&&o(v)}),[v]);return{selectedValue:i,selectValue:(0,s.useCallback)((e=>{if(!p({value:e,tabValues:r}))throw new Error(`Can't select invalid tab value=${e}`);o(e),d(e),b(e)}),[d,b,r]),tabValues:r}}var b=t(9136);const v={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var x=t(4848);function g(e){let{className:n,block:t,selectedValue:s,selectValue:i,tabValues:l}=e;const o=[],{blockElementScrollPositionUntilNextRender:c}=(0,r.a_)(),u=e=>{const n=e.currentTarget,t=o.indexOf(n),a=l[t].value;a!==s&&(c(n),i(a))},d=e=>{let n=null;switch(e.key){case"Enter":u(e);break;case"ArrowRight":{const t=o.indexOf(e.currentTarget)+1;n=o[t]??o[0];break}case"ArrowLeft":{const t=o.indexOf(e.currentTarget)-1;n=o[t]??o[o.length-1];break}}n?.focus()};return(0,x.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,a.A)("tabs",{"tabs--block":t},n),children:l.map((e=>{let{value:n,label:t,attributes:r}=e;return(0,x.jsx)("li",{role:"tab",tabIndex:s===n?0:-1,"aria-selected":s===n,ref:e=>{o.push(e)},onKeyDown:d,onClick:u,...r,className:(0,a.A)("tabs__item",v.tabItem,r?.className,{"tabs__item--active":s===n}),children:t??n},n)}))})}function j(e){let{lazy:n,children:t,selectedValue:r}=e;const i=(Array.isArray(t)?t:[t]).filter(Boolean);if(n){const e=i.find((e=>e.props.value===r));return e?(0,s.cloneElement)(e,{className:(0,a.A)("margin-top--md",e.props.className)}):null}return(0,x.jsx)("div",{className:"margin-top--md",children:i.map(((e,n)=>(0,s.cloneElement)(e,{key:n,hidden:e.props.value!==r})))})}function k(e){const n=f(e);return(0,x.jsxs)("div",{className:(0,a.A)("tabs-container",v.tabList),children:[(0,x.jsx)(g,{...n,...e}),(0,x.jsx)(j,{...n,...e})]})}function y(e){const n=(0,b.A)();return(0,x.jsx)(k,{...e,children:d(e.children)},String(n))}},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>l});var s=t(6540);const a={},r=s.createContext(a);function i(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),s.createElement(r.Provider,{value:n},e.children)}},9329:(e,n,t)=>{t.d(n,{A:()=>i});t(6540);var s=t(4164);const a={tabItem:"tabItem_Ymn6"};var r=t(4848);function i(e){let{children:n,hidden:t,className:i}=e;return(0,r.jsx)("div",{role:"tabpanel",className:(0,s.A)(a.tabItem,i),hidden:t,children:n})}}}]);